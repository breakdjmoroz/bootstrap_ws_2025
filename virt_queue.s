.section .bss
.align 4096
# –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É (4096 –±–∞–π—Ç) –¥–ª—è virtqueue.
virtqueue_space:
    .space 4096

.section .text
.global virtqueue_init

# –§—É–Ω–∫—Ü–∏—è virtqueue_init
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç virtqueue 0, –≤—ã–¥–µ–ª—è—è –ø–∞–º—è—Ç—å –¥–ª—è –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, avail- –∏ used-–∫–æ–ª—å—Ü–∞.
#
# –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ MMIO-—Ä–µ–≥–∏—Å—Ç—Ä—ã virtio:
# 0x30: Queue Select (16-–±–∏—Ç)
# 0x34: Queue Size (16-–±–∏—Ç) ‚Äì –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
# 0x3c: Queue Align (32-–±–∏—Ç) ‚Äì —Ç—Ä–µ–±—É–µ–º–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (–æ–±—ã—á–Ω–æ 4096)
# 0x40: Queue Pfn (32-–±–∏—Ç) ‚Äì —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–∑–º–µ—â–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å
#
# –í a0 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 0 –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ, -1 –ø—Ä–∏ –æ—à–∏–±–∫–µ.
virtqueue_init:
    # t0 = –±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å virtio-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (MMIO)
    li      t0, 0x10001000

    # –í—ã–±–∏—Ä–∞–µ–º –æ—á–µ—Ä–µ–¥—å 0
    li      t1, 0
    sw      t1, 0x30(t0)       # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º queue_select = 0

    # –ß–∏—Ç–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞ queue_size (—Å–º–µ—â–µ–Ω–∏–µ 0x38)
    lw      t2, 0x34(t0)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ –Ω—É–ª–µ–≤–æ–µ —á–∏—Å–ª–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤.
    beqz    t2, virtqueue_fail
    # –í—ã–±–∏—Ä–∞–µ–º —á–∏—Å–ª–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, üòç
    li      t3, 4              # NUM_DESCS = 8
    # –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 8 –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É.
    blt     t2, t3, virtqueue_fail

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–±—É–µ–º–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: 4096 –±–∞–π—Ç.
    li      t4, 4096           # queue_align = 4096
    sw      t4, 0x3c(t0)

    # –í—ã—á–∏—Å–ª—è–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è virtqueue.
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ virtqueue_space –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º—É –∞–¥—Ä–µ—Å—É, —Ä–∞–≤–Ω–æ–º—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É.
    la      t5, virtqueue_space  # t5 = –∞–¥—Ä–µ—Å virtqueue_space
    # –†–∞–∑–¥–µ–ª–∏–º –∞–¥—Ä–µ—Å –Ω–∞ 4096 (—Å–¥–≤–∏–≥ –≤–ø—Ä–∞–≤–æ –Ω–∞ 12 –±–∏—Ç)
    srli    t6, t5, 12
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ä–µ–≥–∏—Å—Ç—Ä queue_pfn (—Å–º–µ—â–µ–Ω–∏–µ 0x44)
    sw      t6, 0x40(t0)

    # (–î–∞–ª–µ–µ –º–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å: –æ–±–Ω—É–ª–∏—Ç—å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –∏ –∫–æ–ª—å—Ü–∞, –Ω–æ –∑–¥–µ—Å—å –º—ã –ª–∏—à—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–¥–∞—á—É –ø–∞–º—è—Ç–∏.)
    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ ‚Äì –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0.
    li      a3, 0
    ret

virtqueue_fail:
    li      a3, -1
    ret

